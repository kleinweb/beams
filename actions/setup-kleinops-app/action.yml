# yaml-language-server: $schema=https://json.schemastore.org/github-action.json
---

# yamllint disable rule:line-length

name: Setup Kleinops GitHub App
description: "Initialize the organization operations GitHub app"

inputs:
  app-id:
    required: true
    description: "GitHub app ID"
  private-key:
    required: true
    description: 'GitHub app private key'

outputs:
  slug:
    description: "Slug for the app"
    value: ${{ steps.app-token.outputs.app-slug }}
  token:
    description: "Token generated by the app"
    value: ${{ steps.app-token.outputs.token }}
  user_id:
    description: "ID for the GitHub user associated with the app"
    value: ${{ steps.app-user.outputs.id }}
  user_name:
    description: "Git user name for the app user"
    value: ${{ steps.app-user.outputs.name }}
  user_email:
    description: "Git user email for the app user"
    value: ${{ steps.app-user.outputs.email }}

runs:
  using: composite
  steps:
    - uses: actions/create-github-app-token@v2
      id: app-token
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.private-key }}
        owner: ${{ github.repository_owner }}

    - name: Get GitHub app user
      id: app-user
      shell: bash
      run: |
        APP_SLUG="${{ steps.app-token.outputs.app-slug }}"
        USER_ID=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)

        echo "id=${USER_ID}" >> "$GITHUB_OUTPUT"
        echo "name=${APP_SLUG}[bot]" >> "$GITHUB_OUTPUT"
        echo "email=${USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com" >> "$GITHUB_OUTPUT"
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: "Configure Git user with app credentials"
      shell: bash
      run: |
        git config --global user.name ${{ steps.app-user.outputs.name }}
        git config --global user.email ${{ steps.app-user.outputs.email }}
